Return-Path: <linux-cifs-owner@vger.kernel.org>
X-Original-To: lists+linux-cifs@lfdr.de
Delivered-To: lists+linux-cifs@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 637CB2AD160
	for <lists+linux-cifs@lfdr.de>; Tue, 10 Nov 2020 09:35:58 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726462AbgKJIfz (ORCPT <rfc822;lists+linux-cifs@lfdr.de>);
        Tue, 10 Nov 2020 03:35:55 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33736 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726690AbgKJIfy (ORCPT
        <rfc822;linux-cifs@vger.kernel.org>); Tue, 10 Nov 2020 03:35:54 -0500
Received: from mail-wr1-x42e.google.com (mail-wr1-x42e.google.com [IPv6:2a00:1450:4864:20::42e])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 57B1BC0613CF
        for <linux-cifs@vger.kernel.org>; Tue, 10 Nov 2020 00:35:52 -0800 (PST)
Received: by mail-wr1-x42e.google.com with SMTP id r17so7787601wrw.1
        for <linux-cifs@vger.kernel.org>; Tue, 10 Nov 2020 00:35:52 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:from:date:message-id:subject:to:cc;
        bh=FpygzreFvvF82ACCYjFqI6LDVJwFIQkd7D2cN6AgNcw=;
        b=CENxI0QCXaDPiEb60tuDF+0pzTLJm1KoQz2gFpPq+qAXd1FkuA+MsjxEpSkTDxzWJr
         uACZX/SUN6kJ2xF+ajdUBrt0BAnq+AWLmNWMjT9oXYEaQTOmhv2tBCw6a9X3H/y0JB5a
         Ocr4jE4PJgbfB1g6KL5pbeFD613oIpOzWdbAEO/xUd8At3bU1OLUopsFEzdgC42o8vdG
         LJ+44TkJaFGpQfOFiifyzKJmantymYXp/gDhsoUdVehVuO2i+59/2HWs34MAfr8HbNhk
         mCHCf8RMR/N+rwiq4MB+20oTpnMlAYNCl5ov6uQgSeWTwQg9n2Z6Sm7G7vWL9lNFrtFT
         bD9g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:from:date:message-id:subject:to:cc;
        bh=FpygzreFvvF82ACCYjFqI6LDVJwFIQkd7D2cN6AgNcw=;
        b=lXFfKbTjwpAFwjuqOg/jm2YwuwRULGCmiXPxXlDgyNxfbwSSJPhWSxLI349+bXKkpQ
         W5o5UYIhiGJ+eu8wKLCzzBA++2m+nI4W/Y/JdxIhGxrCMfh+1b4bhv5SVd7y6m/t2tbJ
         KfOIbQiIhnNmvYkeJPrEYaNe5wyo8GVzdtHs5yN8fGw/yE/If2EGVt2nLHkAbOjER3Wo
         LFBf2Gw5HH5qPnEZDluHmsw5O6UJT2B+EdLapE6VWjpZLFXeW+lQ+DbXEHhX0St5/ykR
         zZuhjtuje33FWzolMZ7HN7zn/pmUSf6VclHMfNnAj26B71UnQOl8bMhp9uuyA+0ppVed
         WczQ==
X-Gm-Message-State: AOAM531IL+tMTe4c9LStSm/S9pEe4VzdrlLldDtw8IpFWfJNjklA0qxB
        rH5qy5DNfTOtSWUcXEKdnALVNbgaYGpyv/Pp6adg0DcECAU=
X-Google-Smtp-Source: ABdhPJxMOA9E3/wEz+iHWtnZyQAT8WXBmQlF7nBr8VteFvbjnz/E7Xpa1glwonHxcHfoerMqFXt1Ra8+o73vfGt/+bk=
X-Received: by 2002:a5d:5643:: with SMTP id j3mr13115201wrw.43.1604997349681;
 Tue, 10 Nov 2020 00:35:49 -0800 (PST)
MIME-Version: 1.0
From:   Rohith Surabattula <rohiths.msft@gmail.com>
Date:   Tue, 10 Nov 2020 14:05:38 +0530
Message-ID: <CACdtm0YUmSx27NFh7KRwafY+agdTgubZ22QGrx=k8ZmyZit_Ww@mail.gmail.com>
Subject: Handling race conditions during read offload path
To:     linux-cifs <linux-cifs@vger.kernel.org>
Cc:     Steve French <smfrench@gmail.com>,
        Pavel Shilovsky <piastryyy@gmail.com>,
        Shyam Prasad N <nspmangalore@gmail.com>,
        sribhat.msa@outlook.com
Content-Type: multipart/mixed; boundary="000000000000e4c9ad05b3bc90ee"
Precedence: bulk
List-ID: <linux-cifs.vger.kernel.org>
X-Mailing-List: linux-cifs@vger.kernel.org

--000000000000e4c9ad05b3bc90ee
Content-Type: text/plain; charset="UTF-8"

Hi All,

1) During cifs reconnect, there is possibility of MID pending list
corruption when both offload and demultiplex thread tries to dequeue
MID from the list.
2) Mid callback needs to be called only when valid data is read from socket.

So, I have addressed the above issues and attached the patches.

Regards,
Rohith

--000000000000e4c9ad05b3bc90ee
Content-Type: application/octet-stream; 
	name="0003-smb3-Handle-error-case-during-offload-read-path.patch"
Content-Disposition: attachment; 
	filename="0003-smb3-Handle-error-case-during-offload-read-path.patch"
Content-Transfer-Encoding: base64
Content-ID: <f_khbpy49d0>
X-Attachment-Id: f_khbpy49d0

RnJvbSA5OTU5OTJmMGIzMTg5ZTEwNmVmMDUyZWRhNmYwMTA2ODc2MTIxMzRmIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBSb2hpdGggU3VyYWJhdHR1bGEgPHJvaGl0aHNAbWljcm9zb2Z0
LmNvbT4KRGF0ZTogVGh1LCAyOSBPY3QgMjAyMCAwNjowNzo1NiArMDAwMApTdWJqZWN0OiBbUEFU
Q0ggMy8zXSBzbWIzOiBIYW5kbGUgZXJyb3IgY2FzZSBkdXJpbmcgb2ZmbG9hZCByZWFkIHBhdGgK
Ck1pZCBjYWxsYmFjayBuZWVkcyB0byBiZSBjYWxsZWQgb25seSB3aGVuIHZhbGlkIGRhdGEgaXMK
cmVhZCBpbnRvIHBhZ2VzLgoKU2lnbmVkLW9mZi1ieTogUm9oaXRoIFN1cmFiYXR0dWxhIDxyb2hp
dGhzQG1pY3Jvc29mdC5jb20+ClJldmlld2VkLWJ5OiBQYXZlbCBTaGlsb3Zza3kgPHBzaGlsb3ZA
bWljcm9zb2Z0LmNvbT4KLS0tCiBmcy9jaWZzL3NtYjJvcHMuYyB8IDIwICsrKysrKysrKysrKysr
KysrKystCiAxIGZpbGUgY2hhbmdlZCwgMTkgaW5zZXJ0aW9ucygrKSwgMSBkZWxldGlvbigtKQoK
ZGlmZiAtLWdpdCBhL2ZzL2NpZnMvc21iMm9wcy5jIGIvZnMvY2lmcy9zbWIyb3BzLmMKaW5kZXgg
YjNiMmFiYmI0OWI5Li5kYWI5NGY2N2M5ODggMTAwNjQ0Ci0tLSBhL2ZzL2NpZnMvc21iMm9wcy5j
CisrKyBiL2ZzL2NpZnMvc21iMm9wcy5jCkBAIC00NTU5LDcgKzQ1NTksMjUgQEAgc3RhdGljIHZv
aWQgc21iMl9kZWNyeXB0X29mZmxvYWQoc3RydWN0IHdvcmtfc3RydWN0ICp3b3JrKQogCQkJCSAg
ICAgIGR3LT5zZXJ2ZXItPnZhbHMtPnJlYWRfcnNwX3NpemUsCiAJCQkJICAgICAgZHctPnBwYWdl
cywgZHctPm5wYWdlcywgZHctPmxlbiwKIAkJCQkgICAgICB0cnVlKTsKLQkJbWlkLT5jYWxsYmFj
ayhtaWQpOworCQlpZiAocmMgPj0gMCkgeworI2lmZGVmIENPTkZJR19DSUZTX1NUQVRTMgorCQkJ
bWlkLT53aGVuX3JlY2VpdmVkID0gamlmZmllczsKKyNlbmRpZgorCQkJbWlkLT5jYWxsYmFjayht
aWQpOworCQl9IGVsc2UgeworCQkJc3Bpbl9sb2NrKCZHbG9iYWxNaWRfTG9jayk7CisJCQlpZiAo
ZHctPnNlcnZlci0+dGNwU3RhdHVzID09IENpZnNOZWVkUmVjb25uZWN0KSB7CisJCQkJbWlkLT5t
aWRfc3RhdGUgPSBNSURfUkVUUllfTkVFREVEOworCQkJCXNwaW5fdW5sb2NrKCZHbG9iYWxNaWRf
TG9jayk7CisJCQkJbWlkLT5jYWxsYmFjayhtaWQpOworCQkJfSBlbHNlIHsKKwkJCQltaWQtPm1p
ZF9zdGF0ZSA9IE1JRF9SRVFVRVNUX1NVQk1JVFRFRDsKKwkJCQltaWQtPm1pZF9mbGFncyAmPSB+
KE1JRF9ERUxFVEVEKTsKKwkJCQlsaXN0X2FkZF90YWlsKCZtaWQtPnFoZWFkLAorCQkJCQkmZHct
PnNlcnZlci0+cGVuZGluZ19taWRfcSk7CisJCQkJc3Bpbl91bmxvY2soJkdsb2JhbE1pZF9Mb2Nr
KTsKKwkJCX0KKwkJfQogCQljaWZzX21pZF9xX2VudHJ5X3JlbGVhc2UobWlkKTsKIAl9CiAKLS0g
CjIuMjUuMQoK
--000000000000e4c9ad05b3bc90ee
Content-Type: application/octet-stream; 
	name="0001-smb3-Call-cifs-reconnect-from-demultiplex-thread.patch"
Content-Disposition: attachment; 
	filename="0001-smb3-Call-cifs-reconnect-from-demultiplex-thread.patch"
Content-Transfer-Encoding: base64
Content-ID: <f_khbpy4a22>
X-Attachment-Id: f_khbpy4a22

RnJvbSA4MzQ0ZGFmMTdiNGY2ZmNkYmEzNDBhMDhlOGQ2MjJmNjc3NzJhMTNmIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBSb2hpdGggU3VyYWJhdHR1bGEgPHJvaGl0aHNAbWljcm9zb2Z0
LmNvbT4KRGF0ZTogV2VkLCAyOCBPY3QgMjAyMCAxMzo0MjoyMSArMDAwMApTdWJqZWN0OiBbUEFU
Q0ggMS8zXSBzbWIzOiBDYWxsIGNpZnMgcmVjb25uZWN0IGZyb20gZGVtdWx0aXBsZXggdGhyZWFk
CgpjaWZzX3JlY29ubmVjdCBuZWVkcyB0byBiZSBjYWxsZWQgb25seSBmcm9tIGRlbXVsdGlwbGV4
IHRocmVhZC4Kc2tpcCBjaWZzX3JlY29ubmVjdCBpbiBvZmZsb2FkIHRocmVhZC4gU28sIGNpZnNf
cmVjb25uZWN0IHdpbGwgYmUKY2FsbGVkIGJ5IGRlbXVsdGlwbGV4IHRocmVhZCBpbiBzdWJzZXF1
ZW50IHJlcXVlc3QuCgpTaWduZWQtb2ZmLWJ5OiBSb2hpdGggU3VyYWJhdHR1bGEgPHJvaGl0aHNA
bWljcm9zb2Z0LmNvbT4KUmV2aWV3ZWQtYnk6IFBhdmVsIFNoaWxvdnNreSA8cHNoaWxvdkBtaWNy
b3NvZnQuY29tPgotLS0KIGZzL2NpZnMvc21iMm9wcy5jIHwgMTMgKysrKysrKystLS0tLQogMSBm
aWxlIGNoYW5nZWQsIDggaW5zZXJ0aW9ucygrKSwgNSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQg
YS9mcy9jaWZzL3NtYjJvcHMuYyBiL2ZzL2NpZnMvc21iMm9wcy5jCmluZGV4IDUwNDc2NmNiNmMx
OS4uZWZlZGVjMmI2NmM2IDEwMDY0NAotLS0gYS9mcy9jaWZzL3NtYjJvcHMuYworKysgYi9mcy9j
aWZzL3NtYjJvcHMuYwpAQCAtNDM1Niw3ICs0MzU2LDggQEAgaW5pdF9yZWFkX2J2ZWMoc3RydWN0
IHBhZ2UgKipwYWdlcywgdW5zaWduZWQgaW50IG5wYWdlcywgdW5zaWduZWQgaW50IGRhdGFfc2l6
ZSwKIHN0YXRpYyBpbnQKIGhhbmRsZV9yZWFkX2RhdGEoc3RydWN0IFRDUF9TZXJ2ZXJfSW5mbyAq
c2VydmVyLCBzdHJ1Y3QgbWlkX3FfZW50cnkgKm1pZCwKIAkJIGNoYXIgKmJ1ZiwgdW5zaWduZWQg
aW50IGJ1Zl9sZW4sIHN0cnVjdCBwYWdlICoqcGFnZXMsCi0JCSB1bnNpZ25lZCBpbnQgbnBhZ2Vz
LCB1bnNpZ25lZCBpbnQgcGFnZV9kYXRhX3NpemUpCisJCSB1bnNpZ25lZCBpbnQgbnBhZ2VzLCB1
bnNpZ25lZCBpbnQgcGFnZV9kYXRhX3NpemUsCisJCSBib29sIGlzX29mZmxvYWRlZCkKIHsKIAl1
bnNpZ25lZCBpbnQgZGF0YV9vZmZzZXQ7CiAJdW5zaWduZWQgaW50IGRhdGFfbGVuOwpAQCAtNDM3
OCw3ICs0Mzc5LDggQEAgaGFuZGxlX3JlYWRfZGF0YShzdHJ1Y3QgVENQX1NlcnZlcl9JbmZvICpz
ZXJ2ZXIsIHN0cnVjdCBtaWRfcV9lbnRyeSAqbWlkLAogCiAJaWYgKHNlcnZlci0+b3BzLT5pc19z
ZXNzaW9uX2V4cGlyZWQgJiYKIAkgICAgc2VydmVyLT5vcHMtPmlzX3Nlc3Npb25fZXhwaXJlZChi
dWYpKSB7Ci0JCWNpZnNfcmVjb25uZWN0KHNlcnZlcik7CisJCWlmICghaXNfb2ZmbG9hZGVkKQor
CQkJY2lmc19yZWNvbm5lY3Qoc2VydmVyKTsKIAkJcmV0dXJuIC0xOwogCX0KIApAQCAtNDUxOCw3
ICs0NTIwLDggQEAgc3RhdGljIHZvaWQgc21iMl9kZWNyeXB0X29mZmxvYWQoc3RydWN0IHdvcmtf
c3RydWN0ICp3b3JrKQogCQltaWQtPmRlY3J5cHRlZCA9IHRydWU7CiAJCXJjID0gaGFuZGxlX3Jl
YWRfZGF0YShkdy0+c2VydmVyLCBtaWQsIGR3LT5idWYsCiAJCQkJICAgICAgZHctPnNlcnZlci0+
dmFscy0+cmVhZF9yc3Bfc2l6ZSwKLQkJCQkgICAgICBkdy0+cHBhZ2VzLCBkdy0+bnBhZ2VzLCBk
dy0+bGVuKTsKKwkJCQkgICAgICBkdy0+cHBhZ2VzLCBkdy0+bnBhZ2VzLCBkdy0+bGVuLAorCQkJ
CSAgICAgIHRydWUpOwogCQltaWQtPmNhbGxiYWNrKG1pZCk7CiAJCWNpZnNfbWlkX3FfZW50cnlf
cmVsZWFzZShtaWQpOwogCX0KQEAgLTQ2MjIsNyArNDYyNSw3IEBAIHJlY2VpdmVfZW5jcnlwdGVk
X3JlYWQoc3RydWN0IFRDUF9TZXJ2ZXJfSW5mbyAqc2VydmVyLCBzdHJ1Y3QgbWlkX3FfZW50cnkg
KiptaWQsCiAJCSgqbWlkKS0+ZGVjcnlwdGVkID0gdHJ1ZTsKIAkJcmMgPSBoYW5kbGVfcmVhZF9k
YXRhKHNlcnZlciwgKm1pZCwgYnVmLAogCQkJCSAgICAgIHNlcnZlci0+dmFscy0+cmVhZF9yc3Bf
c2l6ZSwKLQkJCQkgICAgICBwYWdlcywgbnBhZ2VzLCBsZW4pOworCQkJCSAgICAgIHBhZ2VzLCBu
cGFnZXMsIGxlbiwgZmFsc2UpOwogCX0KIAogZnJlZV9wYWdlczoKQEAgLTQ3NjUsNyArNDc2OCw3
IEBAIHNtYjNfaGFuZGxlX3JlYWRfZGF0YShzdHJ1Y3QgVENQX1NlcnZlcl9JbmZvICpzZXJ2ZXIs
IHN0cnVjdCBtaWRfcV9lbnRyeSAqbWlkKQogCWNoYXIgKmJ1ZiA9IHNlcnZlci0+bGFyZ2VfYnVm
ID8gc2VydmVyLT5iaWdidWYgOiBzZXJ2ZXItPnNtYWxsYnVmOwogCiAJcmV0dXJuIGhhbmRsZV9y
ZWFkX2RhdGEoc2VydmVyLCBtaWQsIGJ1Ziwgc2VydmVyLT5wZHVfc2l6ZSwKLQkJCQlOVUxMLCAw
LCAwKTsKKwkJCQlOVUxMLCAwLCAwLCBmYWxzZSk7CiB9CiAKIHN0YXRpYyBpbnQKLS0gCjIuMjUu
MQoK
--000000000000e4c9ad05b3bc90ee
Content-Type: application/octet-stream; 
	name="0002-smb3-Avoid-Mid-pending-list-corruption.patch"
Content-Disposition: attachment; 
	filename="0002-smb3-Avoid-Mid-pending-list-corruption.patch"
Content-Transfer-Encoding: base64
Content-ID: <f_khbpy49y1>
X-Attachment-Id: f_khbpy49y1

RnJvbSBlNmY4MjcwZWU1M2RhM2E2MTAxZTUyYWVkOWU3ZTFjZGJjOGNhMjg0IE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBSb2hpdGggU3VyYWJhdHR1bGEgPHJvaGl0aHNAbWljcm9zb2Z0
LmNvbT4KRGF0ZTogVGh1LCAyOSBPY3QgMjAyMCAwNTowMzoxMCArMDAwMApTdWJqZWN0OiBbUEFU
Q0ggMi8zXSBzbWIzOiBBdm9pZCBNaWQgcGVuZGluZyBsaXN0IGNvcnJ1cHRpb24KCldoZW4gcmVj
b25uZWN0IGhhcHBlbnMgTWlkIHF1ZXVlIGNhbiBiZSBjb3JydXB0ZWQgd2hlbiBib3RoCmRlbXVs
dGlwbGV4IGFuZCBvZmZsb2FkIHRocmVhZCB0cnkgdG8gZGVxdWV1ZSB0aGUgTUlEIGZyb20gdGhl
CnBlbmRpbmcgbGlzdC4KClNpZ25lZC1vZmYtYnk6IFJvaGl0aCBTdXJhYmF0dHVsYSA8cm9oaXRo
c0BtaWNyb3NvZnQuY29tPgpSZXZpZXdlZC1ieTogUGF2ZWwgU2hpbG92c2t5IDxwc2hpbG92QG1p
Y3Jvc29mdC5jb20+Ci0tLQogZnMvY2lmcy9zbWIyb3BzLmMgfCA1NSArKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKystLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDQ2IGluc2Vy
dGlvbnMoKyksIDkgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZnMvY2lmcy9zbWIyb3BzLmMg
Yi9mcy9jaWZzL3NtYjJvcHMuYwppbmRleCBlZmVkZWMyYjY2YzYuLmIzYjJhYmJiNDliOSAxMDA2
NDQKLS0tIGEvZnMvY2lmcy9zbWIyb3BzLmMKKysrIGIvZnMvY2lmcy9zbWIyb3BzLmMKQEAgLTI2
NCw3ICsyNjQsNyBAQCBzbWIyX3JldmVydF9jdXJyZW50X21pZChzdHJ1Y3QgVENQX1NlcnZlcl9J
bmZvICpzZXJ2ZXIsIGNvbnN0IHVuc2lnbmVkIGludCB2YWwpCiB9CiAKIHN0YXRpYyBzdHJ1Y3Qg
bWlkX3FfZW50cnkgKgotc21iMl9maW5kX21pZChzdHJ1Y3QgVENQX1NlcnZlcl9JbmZvICpzZXJ2
ZXIsIGNoYXIgKmJ1ZikKK19fc21iMl9maW5kX21pZChzdHJ1Y3QgVENQX1NlcnZlcl9JbmZvICpz
ZXJ2ZXIsIGNoYXIgKmJ1ZiwgYm9vbCBkZXF1ZXVlKQogewogCXN0cnVjdCBtaWRfcV9lbnRyeSAq
bWlkOwogCXN0cnVjdCBzbWIyX3N5bmNfaGRyICpzaGRyID0gKHN0cnVjdCBzbWIyX3N5bmNfaGRy
ICopYnVmOwpAQCAtMjgxLDYgKzI4MSwxMCBAQCBzbWIyX2ZpbmRfbWlkKHN0cnVjdCBUQ1BfU2Vy
dmVyX0luZm8gKnNlcnZlciwgY2hhciAqYnVmKQogCQkgICAgKG1pZC0+bWlkX3N0YXRlID09IE1J
RF9SRVFVRVNUX1NVQk1JVFRFRCkgJiYKIAkJICAgIChtaWQtPmNvbW1hbmQgPT0gc2hkci0+Q29t
bWFuZCkpIHsKIAkJCWtyZWZfZ2V0KCZtaWQtPnJlZmNvdW50KTsKKwkJCWlmIChkZXF1ZXVlKSB7
CisJCQkJbGlzdF9kZWxfaW5pdCgmbWlkLT5xaGVhZCk7CisJCQkJbWlkLT5taWRfZmxhZ3MgfD0g
TUlEX0RFTEVURUQ7CisJCQl9CiAJCQlzcGluX3VubG9jaygmR2xvYmFsTWlkX0xvY2spOwogCQkJ
cmV0dXJuIG1pZDsKIAkJfQpAQCAtMjg5LDYgKzI5MywxOCBAQCBzbWIyX2ZpbmRfbWlkKHN0cnVj
dCBUQ1BfU2VydmVyX0luZm8gKnNlcnZlciwgY2hhciAqYnVmKQogCXJldHVybiBOVUxMOwogfQog
CitzdGF0aWMgc3RydWN0IG1pZF9xX2VudHJ5ICoKK3NtYjJfZmluZF9taWQoc3RydWN0IFRDUF9T
ZXJ2ZXJfSW5mbyAqc2VydmVyLCBjaGFyICpidWYpCit7CisJcmV0dXJuIF9fc21iMl9maW5kX21p
ZChzZXJ2ZXIsIGJ1ZiwgZmFsc2UpOworfQorCitzdGF0aWMgc3RydWN0IG1pZF9xX2VudHJ5ICoK
K3NtYjJfZmluZF9kZXF1ZXVlX21pZChzdHJ1Y3QgVENQX1NlcnZlcl9JbmZvICpzZXJ2ZXIsIGNo
YXIgKmJ1ZikKK3sKKwlyZXR1cm4gX19zbWIyX2ZpbmRfbWlkKHNlcnZlciwgYnVmLCB0cnVlKTsK
K30KKwogc3RhdGljIHZvaWQKIHNtYjJfZHVtcF9kZXRhaWwodm9pZCAqYnVmLCBzdHJ1Y3QgVENQ
X1NlcnZlcl9JbmZvICpzZXJ2ZXIpCiB7CkBAIC00NDA0LDcgKzQ0MjAsMTAgQEAgaGFuZGxlX3Jl
YWRfZGF0YShzdHJ1Y3QgVENQX1NlcnZlcl9JbmZvICpzZXJ2ZXIsIHN0cnVjdCBtaWRfcV9lbnRy
eSAqbWlkLAogCQljaWZzX2RiZyhGWUksICIlczogc2VydmVyIHJldHVybmVkIGVycm9yICVkXG4i
LAogCQkJIF9fZnVuY19fLCByZGF0YS0+cmVzdWx0KTsKIAkJLyogbm9ybWFsIGVycm9yIG9uIHJl
YWQgcmVzcG9uc2UgKi8KLQkJZGVxdWV1ZV9taWQobWlkLCBmYWxzZSk7CisJCWlmIChpc19vZmZs
b2FkZWQpCisJCQltaWQtPm1pZF9zdGF0ZSA9IE1JRF9SRVNQT05TRV9SRUNFSVZFRDsKKwkJZWxz
ZQorCQkJZGVxdWV1ZV9taWQobWlkLCBmYWxzZSk7CiAJCXJldHVybiAwOwogCX0KIApAQCAtNDQy
OCw3ICs0NDQ3LDEwIEBAIGhhbmRsZV9yZWFkX2RhdGEoc3RydWN0IFRDUF9TZXJ2ZXJfSW5mbyAq
c2VydmVyLCBzdHJ1Y3QgbWlkX3FfZW50cnkgKm1pZCwKIAkJY2lmc19kYmcoRllJLCAiJXM6IGRh
dGEgb2Zmc2V0ICgldSkgYmV5b25kIGVuZCBvZiBzbWFsbGJ1ZlxuIiwKIAkJCSBfX2Z1bmNfXywg
ZGF0YV9vZmZzZXQpOwogCQlyZGF0YS0+cmVzdWx0ID0gLUVJTzsKLQkJZGVxdWV1ZV9taWQobWlk
LCByZGF0YS0+cmVzdWx0KTsKKwkJaWYgKGlzX29mZmxvYWRlZCkKKwkJCW1pZC0+bWlkX3N0YXRl
ID0gTUlEX1JFU1BPTlNFX01BTEZPUk1FRDsKKwkJZWxzZQorCQkJZGVxdWV1ZV9taWQobWlkLCBy
ZGF0YS0+cmVzdWx0KTsKIAkJcmV0dXJuIDA7CiAJfQogCkBAIC00NDQ0LDIxICs0NDY2LDMwIEBA
IGhhbmRsZV9yZWFkX2RhdGEoc3RydWN0IFRDUF9TZXJ2ZXJfSW5mbyAqc2VydmVyLCBzdHJ1Y3Qg
bWlkX3FfZW50cnkgKm1pZCwKIAkJCWNpZnNfZGJnKEZZSSwgIiVzOiBkYXRhIG9mZnNldCAoJXUp
IGJleW9uZCAxc3QgcGFnZSBvZiByZXNwb25zZVxuIiwKIAkJCQkgX19mdW5jX18sIGRhdGFfb2Zm
c2V0KTsKIAkJCXJkYXRhLT5yZXN1bHQgPSAtRUlPOwotCQkJZGVxdWV1ZV9taWQobWlkLCByZGF0
YS0+cmVzdWx0KTsKKwkJCWlmIChpc19vZmZsb2FkZWQpCisJCQkJbWlkLT5taWRfc3RhdGUgPSBN
SURfUkVTUE9OU0VfTUFMRk9STUVEOworCQkJZWxzZQorCQkJCWRlcXVldWVfbWlkKG1pZCwgcmRh
dGEtPnJlc3VsdCk7CiAJCQlyZXR1cm4gMDsKIAkJfQogCiAJCWlmIChkYXRhX2xlbiA+IHBhZ2Vf
ZGF0YV9zaXplIC0gcGFkX2xlbikgewogCQkJLyogZGF0YV9sZW4gaXMgY29ycnVwdCAtLSBkaXNj
YXJkIGZyYW1lICovCiAJCQlyZGF0YS0+cmVzdWx0ID0gLUVJTzsKLQkJCWRlcXVldWVfbWlkKG1p
ZCwgcmRhdGEtPnJlc3VsdCk7CisJCQlpZiAoaXNfb2ZmbG9hZGVkKQorCQkJCW1pZC0+bWlkX3N0
YXRlID0gTUlEX1JFU1BPTlNFX01BTEZPUk1FRDsKKwkJCWVsc2UKKwkJCQlkZXF1ZXVlX21pZCht
aWQsIHJkYXRhLT5yZXN1bHQpOwogCQkJcmV0dXJuIDA7CiAJCX0KIAogCQlyZGF0YS0+cmVzdWx0
ID0gaW5pdF9yZWFkX2J2ZWMocGFnZXMsIG5wYWdlcywgcGFnZV9kYXRhX3NpemUsCiAJCQkJCSAg
ICAgICBjdXJfb2ZmLCAmYnZlYyk7CiAJCWlmIChyZGF0YS0+cmVzdWx0ICE9IDApIHsKLQkJCWRl
cXVldWVfbWlkKG1pZCwgcmRhdGEtPnJlc3VsdCk7CisJCQlpZiAoaXNfb2ZmbG9hZGVkKQorCQkJ
CW1pZC0+bWlkX3N0YXRlID0gTUlEX1JFU1BPTlNFX01BTEZPUk1FRDsKKwkJCWVsc2UKKwkJCQlk
ZXF1ZXVlX21pZChtaWQsIHJkYXRhLT5yZXN1bHQpOwogCQkJcmV0dXJuIDA7CiAJCX0KIApAQCAt
NDQ3Myw3ICs0NTA0LDEwIEBAIGhhbmRsZV9yZWFkX2RhdGEoc3RydWN0IFRDUF9TZXJ2ZXJfSW5m
byAqc2VydmVyLCBzdHJ1Y3QgbWlkX3FfZW50cnkgKm1pZCwKIAkJLyogcmVhZCByZXNwb25zZSBw
YXlsb2FkIGNhbm5vdCBiZSBpbiBib3RoIGJ1ZiBhbmQgcGFnZXMgKi8KIAkJV0FSTl9PTkNFKDEs
ICJidWYgY2FuIG5vdCBjb250YWluIG9ubHkgYSBwYXJ0IG9mIHJlYWQgZGF0YSIpOwogCQlyZGF0
YS0+cmVzdWx0ID0gLUVJTzsKLQkJZGVxdWV1ZV9taWQobWlkLCByZGF0YS0+cmVzdWx0KTsKKwkJ
aWYgKGlzX29mZmxvYWRlZCkKKwkJCW1pZC0+bWlkX3N0YXRlID0gTUlEX1JFU1BPTlNFX01BTEZP
Uk1FRDsKKwkJZWxzZQorCQkJZGVxdWV1ZV9taWQobWlkLCByZGF0YS0+cmVzdWx0KTsKIAkJcmV0
dXJuIDA7CiAJfQogCkBAIC00NDg0LDcgKzQ1MTgsMTAgQEAgaGFuZGxlX3JlYWRfZGF0YShzdHJ1
Y3QgVENQX1NlcnZlcl9JbmZvICpzZXJ2ZXIsIHN0cnVjdCBtaWRfcV9lbnRyeSAqbWlkLAogCWlm
IChsZW5ndGggPCAwKQogCQlyZXR1cm4gbGVuZ3RoOwogCi0JZGVxdWV1ZV9taWQobWlkLCBmYWxz
ZSk7CisJaWYgKGlzX29mZmxvYWRlZCkKKwkJbWlkLT5taWRfc3RhdGUgPSBNSURfUkVTUE9OU0Vf
UkVDRUlWRUQ7CisJZWxzZQorCQlkZXF1ZXVlX21pZChtaWQsIGZhbHNlKTsKIAlyZXR1cm4gbGVu
Z3RoOwogfQogCkBAIC00NTEzLDcgKzQ1NTAsNyBAQCBzdGF0aWMgdm9pZCBzbWIyX2RlY3J5cHRf
b2ZmbG9hZChzdHJ1Y3Qgd29ya19zdHJ1Y3QgKndvcmspCiAJfQogCiAJZHctPnNlcnZlci0+bHN0
cnAgPSBqaWZmaWVzOwotCW1pZCA9IHNtYjJfZmluZF9taWQoZHctPnNlcnZlciwgZHctPmJ1Zik7
CisJbWlkID0gc21iMl9maW5kX2RlcXVldWVfbWlkKGR3LT5zZXJ2ZXIsIGR3LT5idWYpOwogCWlm
IChtaWQgPT0gTlVMTCkKIAkJY2lmc19kYmcoRllJLCAibWlkIG5vdCBmb3VuZFxuIik7CiAJZWxz
ZSB7Ci0tIAoyLjI1LjEKCg==
--000000000000e4c9ad05b3bc90ee
Content-Type: application/octet-stream; 
	name="0000-smb3-handle-race-conditions.patch"
Content-Disposition: attachment; 
	filename="0000-smb3-handle-race-conditions.patch"
Content-Transfer-Encoding: base64
Content-ID: <f_khbpy4ab3>
X-Attachment-Id: f_khbpy4ab3

RnJvbSA5OTU5OTJmMGIzMTg5ZTEwNmVmMDUyZWRhNmYwMTA2ODc2MTIxMzRmIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBSb2hpdGggU3VyYWJhdHR1bGEgPHJvaGl0aHNAbWljcm9zb2Z0
LmNvbT4KRGF0ZTogRnJpLCA2IE5vdiAyMDIwIDA4OjU5OjMzICswMDAwClN1YmplY3Q6IFtQQVRD
SCAwLzNdIHNtYjM6IEhhbmRsaW5nIHJhY2UgY29uZGl0aW9ucyBpbiByZWFkIG9mZmxvYWQgcGF0
aAoKSGFuZGxpbmcgcmFjZSBjb25kaXRpb25zIGR1cmluZyByZWNvbm5lY3QgYW5kIGVycm9yIGNh
c2VzLgoKWyAxMjcxLjM4NjU3N10gQ0lGUzogVkZTOiB0cnlpbmcgdG8gZGVxdWV1ZSBhIGRlbGV0
ZWQgbWlkClsgMTI3MS4zODkzODJdIC0tLS0tLS0tLS0tLVsgY3V0IGhlcmUgXS0tLS0tLS0tLS0t
LQpbIDEyNzEuMzg5MzgzXSByZWZjb3VudF90OiB1bmRlcmZsb3c7IHVzZS1hZnRlci1mcmVlLgpb
IDEyNzEuMzg5Mzk3XSBXQVJOSU5HOiBDUFU6IDEwIFBJRDogNDE0MiBhdCBsaWIvcmVmY291bnQu
YzoyOCByZWZjb3VudF93YXJuX3NhdHVyYXRlKzB4YWUvMHhmMApbIDEyNzEuMzg5Mzk3XSBNb2R1
bGVzIGxpbmtlZCBpbjogY2lmcyhPRSkgbGliYXJjNCBmc2NhY2hlIGxpYmRlcyBjY20gbWQ0IGNt
YWMgbmxzX3V0ZjggeHRfb3duZXIgaXB0YWJsZV9zZWN1cml0eSB4dF9jb25udHJhY2sgbmZfY29u
bnRyYWNrIG5mX2RlZnJhZ19pcHY2IG5mX2RlZnJhZ19pcHY0IGJwZmlsdGVyIG5sc19pc284ODU5
XzEgZG1fbXVsdGlwYXRoIHNjc2lfZGhfcmRhYyBzY3NpX2RoX2VtYyBzY3NpX2RoX2FsdWEgaW50
ZWxfcmFwbF9tc3IgaW50ZWxfcmFwbF9jb21tb24gaXNzdF9pZl9tYm94X21zciBpc3N0X2lmX2Nv
bW1vbiBuZml0IGt2bV9pbnRlbCBrdm0gcmFwbCBtbHg1X2liIGliX3V2ZXJicyBpYl9jb3JlIG1s
eDVfY29yZSB0bHMgbWx4ZncgcGNpX2h5cGVydiBwY2lfaHlwZXJ2X2ludGYgaHZfYmFsbG9vbiBp
bnB1dF9sZWRzIGpveWRldiBtYWNfaGlkIHNlcmlvX3JhdyBzY2hfZnFfY29kZWwgZHJtIGlwX3Rh
YmxlcyB4X3RhYmxlcyBhdXRvZnM0IGJ0cmZzIGJsYWtlMmJfZ2VuZXJpYyByYWlkMTAgcmFpZDQ1
NiBhc3luY19yYWlkNl9yZWNvdiBhc3luY19tZW1jcHkgYXN5bmNfcHEgYXN5bmNfeG9yIGFzeW5j
X3R4IHhvciByYWlkNl9wcSBsaWJjcmMzMmMgcmFpZDEgcmFpZDAgbXVsdGlwYXRoIGxpbmVhciBo
aWRfZ2VuZXJpYyBoaWRfaHlwZXJ2IGNyY3QxMGRpZl9wY2xtdWwgaHZfc3RvcnZzYyBjcmMzMl9w
Y2xtdWwgZ2hhc2hfY2xtdWxuaV9pbnRlbCBzY3NpX3RyYW5zcG9ydF9mYyBoaWQgaHZfbmV0dnNj
IGh2X3V0aWxzIGh5cGVydl9rZXlib2FyZCBhZXNuaV9pbnRlbCBoeXBlcnZfZmIgY3J5cHRvX3Np
bWQgY3J5cHRkIGdsdWVfaGVscGVyIHBzbW91c2UgaHZfdm1idXMgZmxvcHB5IGkyY19waWl4NCBw
YXRhX2FjcGkgW2xhc3QgdW5sb2FkZWQ6IGxpYmFyYzRdClsgMTI3MS4zODk0MjVdIENQVTogMTAg
UElEOiA0MTQyIENvbW06IGt3b3JrZXIvdTY0OjUgVGFpbnRlZDogRyAgICAgICAgICAgT0UgICAg
IDUuOS4wLTA1MDkwMHJjNy1nZW5lcmljICMyMDIwMDkyNzIyMzEKWyAxMjcxLjM4OTQyNl0gSGFy
ZHdhcmUgbmFtZTogTWljcm9zb2Z0IENvcnBvcmF0aW9uIFZpcnR1YWwgTWFjaGluZS9WaXJ0dWFs
IE1hY2hpbmUsIEJJT1MgMDkwMDA4ICAxMi8wNy8yMDE4ClsgMTI3MS4zODk0NTNdIFdvcmtxdWV1
ZTogc21iM2RlY3J5cHRkIHNtYjJfZGVjcnlwdF9vZmZsb2FkIFtjaWZzXQpbIDEyNzEuMzg5NDU2
XSBSSVA6IDAwMTA6cmVmY291bnRfd2Fybl9zYXR1cmF0ZSsweGFlLzB4ZjAKWyAxMjcxLjM4OTQ1
N10gQ29kZTogZmEgMWQgNmEgMDEgMDEgZTggYzcgNDQgYjEgZmYgMGYgMGIgNWQgYzMgODAgM2Qg
ZTcgMWQgNmEgMDEgMDAgNzUgOTEgNDggYzcgYzcgZDggYmUgMWQgYTIgYzYgMDUgZDcgMWQgNmEg
MDEgMDEgZTggYTcgNDQgYjEgZmYgPDBmPiAwYiA1ZCBjMyA4MCAzZCBjNSAxZCA2YSAwMSAwMCAw
ZiA4NSA2ZCBmZiBmZiBmZiA0OCBjNyBjNyAzMCBiZgpbIDEyNzEuMzg5NDU4XSBSU1A6IDAwMTg6
ZmZmZmE0Y2RjMWY4N2UzMCBFRkxBR1M6IDAwMDEwMjg2ClsgMTI3MS4zODk0NThdIFJBWDogMDAw
MDAwMDAwMDAwMDAwMCBSQlg6IGZmZmY5OTc0ZDI4MDlmMDAgUkNYOiBmZmZmOTk3NGRmODk4Y2M4
ClsgMTI3MS4zODk0NTldIFJEWDogMDAwMDAwMDBmZmZmZmZkOCBSU0k6IDAwMDAwMDAwMDAwMDAw
MjcgUkRJOiBmZmZmOTk3NGRmODk4Y2MwClsgMTI3MS4zODk0NjBdIFJCUDogZmZmZmE0Y2RjMWY4
N2UzMCBSMDg6IDAwMDAwMDAwMDAwMDAwMDQgUjA5OiAwMDAwMDAwMDAwMDAwMmMwClsgMTI3MS4z
ODk0NjBdIFIxMDogMDAwMDAwMDAwMDAwMDAwMCBSMTE6IDAwMDAwMDAwMDAwMDAwMDEgUjEyOiBm
ZmZmOTk3NGI3ZmRiNWMwClsgMTI3MS4zODk0NjFdIFIxMzogZmZmZjk5NzRkMjgwOWYwMCBSMTQ6
IGZmZmY5OTc0Y2NlYTBhODAgUjE1OiBmZmZmOTk3NDhlNjBkYjgwClsgMTI3MS4zODk0NjJdIEZT
OiAgMDAwMDAwMDAwMDAwMDAwMCgwMDAwKSBHUzpmZmZmOTk3NGRmODgwMDAwKDAwMDApIGtubEdT
OjAwMDAwMDAwMDAwMDAwMDAKWyAxMjcxLjM4OTQ2Ml0gQ1M6ICAwMDEwIERTOiAwMDAwIEVTOiAw
MDAwIENSMDogMDAwMDAwMDA4MDA1MDAzMwpbIDEyNzEuMzg5NDYzXSBDUjI6IDAwMDA1NWM2MGYz
NDRmZTQgQ1IzOiAwMDAwMDAxMDMxYTNjMDAyIENSNDogMDAwMDAwMDAwMDM3MDZlMApbIDEyNzEu
Mzg5NDY1XSBEUjA6IDAwMDAwMDAwMDAwMDAwMDAgRFIxOiAwMDAwMDAwMDAwMDAwMDAwIERSMjog
MDAwMDAwMDAwMDAwMDAwMApbIDEyNzEuMzg5NDY1XSBEUjM6IDAwMDAwMDAwMDAwMDAwMDAgRFI2
OiAwMDAwMDAwMGZmZmUwZmYwIERSNzogMDAwMDAwMDAwMDAwMDQwMApbIDEyNzEuMzg5NDY2XSBD
YWxsIFRyYWNlOgpbIDEyNzEuMzg5NDgzXSAgY2lmc19taWRfcV9lbnRyeV9yZWxlYXNlKzB4Y2Uv
MHgxMTAgW2NpZnNdClsgMTI3MS4zODk0OTldICBzbWIyX2RlY3J5cHRfb2ZmbG9hZCsweGE5LzB4
MWMwIFtjaWZzXQpbIDEyNzEuMzg5NTAxXSAgcHJvY2Vzc19vbmVfd29yaysweDFlOC8weDNiMApb
IDEyNzEuMzg5NTAzXSAgd29ya2VyX3RocmVhZCsweDUwLzB4MzcwClsgMTI3MS4zODk1MDRdICBr
dGhyZWFkKzB4MTJmLzB4MTUwClsgMTI3MS4zODk1MDZdICA/IHByb2Nlc3Nfb25lX3dvcmsrMHgz
YjAvMHgzYjAKWyAxMjcxLjM4OTUwN10gID8gX19rdGhyZWFkX2JpbmRfbWFzaysweDcwLzB4NzAK
WyAxMjcxLjM4OTUwOV0gIHJldF9mcm9tX2ZvcmsrMHgyMi8weDMwClsgMTI3MS4zODk1MTBdIC0t
LVsgZW5kIHRyYWNlIDhlNDkxMmI2YTRiYzcyNzYgXS0tLQoKUm9oaXRoIFN1cmFiYXR0dWxhICgz
KToKICBzbWIzOiBDYWxsIGNpZnMgcmVjb25uZWN0IGZyb20gZGVtdWx0aXBsZXggdGhyZWFkCiAg
c21iMzogQXZvaWQgTWlkIHBlbmRpbmcgbGlzdCBjb3JydXB0aW9uCiAgc21iMzogSGFuZGxlIGVy
cm9yIGNhc2UgZHVyaW5nIG9mZmxvYWQgcmVhZCBwYXRoCgogZnMvY2lmcy9zbWIyb3BzLmMgfCA4
OCArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLS0tLS0tLQogMSBmaWxl
IGNoYW5nZWQsIDczIGluc2VydGlvbnMoKyksIDE1IGRlbGV0aW9ucygtKQoKLS0gCjIuMjUuMQoK
--000000000000e4c9ad05b3bc90ee--
