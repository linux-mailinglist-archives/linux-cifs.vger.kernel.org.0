Return-Path: <linux-cifs-owner@vger.kernel.org>
X-Original-To: lists+linux-cifs@lfdr.de
Delivered-To: lists+linux-cifs@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id D423A31F9DF
	for <lists+linux-cifs@lfdr.de>; Fri, 19 Feb 2021 14:24:57 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229636AbhBSNYx (ORCPT <rfc822;lists+linux-cifs@lfdr.de>);
        Fri, 19 Feb 2021 08:24:53 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:57560 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229625AbhBSNYw (ORCPT
        <rfc822;linux-cifs@vger.kernel.org>); Fri, 19 Feb 2021 08:24:52 -0500
Received: from mail-yb1-xb36.google.com (mail-yb1-xb36.google.com [IPv6:2607:f8b0:4864:20::b36])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 920CEC061756
        for <linux-cifs@vger.kernel.org>; Fri, 19 Feb 2021 05:24:11 -0800 (PST)
Received: by mail-yb1-xb36.google.com with SMTP id b10so5530426ybn.3
        for <linux-cifs@vger.kernel.org>; Fri, 19 Feb 2021 05:24:11 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:from:date:message-id:subject:to;
        bh=6s7xibgS2f84ch0Mi2tBf9HQBG7isi/G6blr9spjbkg=;
        b=m3OmjNB0g0zgzGV45xDlHw8/TESPbErCxAAe0tWf4EMjyJpTGHedx2VbWrxCbpJGv7
         zoKTI8RS5nHWm3+tACSnjMhT9vt9nCmnBae3SMXqidBkZn+lXsLfzUy+BwdBvbt53Onn
         EAUvgoD/h9LTALw97hTc9UB8UZAxs1yBnu79JpxS4FQStOb6nPTNxQ1nz2qPRNP2moq4
         /VexqQmxsjsLMiAPkBBT1JptNQ0QQZxjBnVak1kq5UEsiLudo92xig/+g1QFdYT/yLlN
         kH8tLTJW27kCuD22mWPCFLCcIW2h6Vb7BQLRn6fOCuxOyqG0PfEsLMdryfMyfj373iNG
         Rn5g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:from:date:message-id:subject:to;
        bh=6s7xibgS2f84ch0Mi2tBf9HQBG7isi/G6blr9spjbkg=;
        b=pNLiQHkmsLPgDRQnVXnBMskd3q/MiACJKYJ6ATE13HtQpdIy68vomq5v/LFrANpytp
         +ugUH3ugo3Rdc30sjCXCvFuWo2hlFWrzxXxIJpqssVpgjTORfgRluqAJZ0Tr2zs2AcU0
         y9EROg9/Sw63U6FktqK8w15SwnXK1SOzwQP34y2hd99iMEFuJJYGxtm/h4BQE8Qlyqqb
         6jcNEBPAKarhTEiobAWz66qGgyB5SYb/ZIjUr1Ykrsl6cYVmwmWDOiDGhxFrA9EsfLNE
         Fit/a+OQsvKV5GmAZkucaPbXtHyjtrDoy2gb5Gd0ECxZU/prjX6g23R0s4p2HIyMdsuO
         teKA==
X-Gm-Message-State: AOAM532isd79H13HGRr+HrVBuu5JTtog8hi1Yb5GnzOSbHH+evwyXze3
        69K8y58jtB3QAhZkuWlb22/QDOoeOmOZb9+BlJc=
X-Google-Smtp-Source: ABdhPJwhqcg9HApmUfTC4Uo7zE58UBf4/mbn9WiDU0Hou3kJ52b4W7+bWyiNn6dvQSmGbzyvJRaubhClXF5KL7WjwLA=
X-Received: by 2002:a25:442:: with SMTP id 63mr13937250ybe.131.1613741050371;
 Fri, 19 Feb 2021 05:24:10 -0800 (PST)
MIME-Version: 1.0
From:   Shyam Prasad N <nspmangalore@gmail.com>
Date:   Fri, 19 Feb 2021 05:23:59 -0800
Message-ID: <CANT5p=rU-DteGZi19OoAWc3cR9qJZ9pxvB5QcpGT3aq=5C8qiw@mail.gmail.com>
Subject: [PATCH 2/2] cifs: Change SIDs in ACEs while transferring file ownership.
To:     Steve French <smfrench@gmail.com>,
        CIFS <linux-cifs@vger.kernel.org>
Content-Type: multipart/mixed; boundary="00000000000011424c05bbb05e87"
Precedence: bulk
List-ID: <linux-cifs.vger.kernel.org>
X-Mailing-List: linux-cifs@vger.kernel.org

--00000000000011424c05bbb05e87
Content-Type: text/plain; charset="UTF-8"

Here's the other one. Below is the test output:
linuxadmin@linuxvm20:/mnt/TestShare/Feb18$ touch file11
linuxadmin@linuxvm20:/mnt/TestShare/Feb18$ chmod 0727 file11
linuxadmin@linuxvm20:/mnt/TestShare/Feb18$ getcifsacl file11
# filename: file11
REVISION:0x1
CONTROL:0x8004
OWNER:LINUXDOMAIN\linuxadmin <<<
GROUP:LINUXDOMAIN\Domain Users
ACL:NT Authority\SYSTEM:ALLOWED/0x0/FULL
ACL:BUILTIN\Users:ALLOWED/0x0/READ
ACL:LINUXDOMAIN\linuxadmin:ALLOWED/0x0/FULL <<<
ACL:LINUXDOMAIN\Domain Users:DENIED/0x0/0xd0131
ACL:LINUXDOMAIN\Domain Users:ALLOWED/0x0/0x1f01de
ACL:\Everyone:ALLOWED/0x0/FULL

linuxadmin@linuxvm20:/mnt/TestShare/Feb18$ chown lxsmbrw file11
linuxadmin@linuxvm20:/mnt/TestShare/Feb18$ getcifsacl file11
# filename: file11
REVISION:0x1
CONTROL:0x8004
OWNER:LINUXDOMAIN\lxsmbrw <<< new owner
GROUP:LINUXDOMAIN\Domain Users
ACL:NT Authority\SYSTEM:ALLOWED/0x0/FULL
ACL:BUILTIN\Users:ALLOWED/0x0/READ
ACL:LINUXDOMAIN\lxsmbrw:ALLOWED/0x0/FULL <<< ACE updated with new owner
ACL:LINUXDOMAIN\Domain Users:DENIED/0x0/0xd0131
ACL:LINUXDOMAIN\Domain Users:ALLOWED/0x0/0x1f01de
ACL:\Everyone:ALLOWED/0x0/FULL

-- 
Regards,
Shyam

--00000000000011424c05bbb05e87
Content-Type: application/octet-stream; 
	name="0002-cifs-Change-SIDs-in-ACEs-while-transferring-file-own.patch"
Content-Disposition: attachment; 
	filename="0002-cifs-Change-SIDs-in-ACEs-while-transferring-file-own.patch"
Content-Transfer-Encoding: base64
Content-ID: <f_klcbqw0z0>
X-Attachment-Id: f_klcbqw0z0

RnJvbSBmMDVmYmMzMjJjMjljZTYzZjM3MjkxMmE2ZTY0M2RlYWIzYmQ1NDI1IE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBTaHlhbSBQcmFzYWQgTiA8c3ByYXNhZEBtaWNyb3NvZnQuY29t
PgpEYXRlOiBUaHUsIDE4IEZlYiAyMDIxIDEzOjAzOjIzICswMDAwClN1YmplY3Q6IFtQQVRDSCAy
LzJdIGNpZnM6IENoYW5nZSBTSURzIGluIEFDRXMgd2hpbGUgdHJhbnNmZXJyaW5nIGZpbGUKIG93
bmVyc2hpcC4KCldpdGggY2lmc2FjbCwgd2hlbiBhIGZpbGUvZGlyIG93bmVyc2hpcCBpcyB0cmFu
c2ZlcnJlZCAoY2hvd24vY2hncnApLAp0aGUgQUNFcyBpbiB0aGUgREFDTCBmb3IgdGhhdCBmaWxl
IHdpbGwgbmVlZCB0byByZXBsYWNlIHRoZSBvbGQgb3duZXIKU0lEcyB3aXRoIHRoZSBuZXcgb3du
ZXIgU0lELgoKU2lnbmVkLW9mZi1ieTogU2h5YW0gUHJhc2FkIE4gPHNwcmFzYWRAbWljcm9zb2Z0
LmNvbT4KLS0tCiBmcy9jaWZzL2NpZnNhY2wuYyB8IDEzNyArKysrKysrKysrKysrKysrKysrKysr
KysrKysrKystLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgOTEgaW5zZXJ0aW9ucygr
KSwgNDYgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZnMvY2lmcy9jaWZzYWNsLmMgYi9mcy9j
aWZzL2NpZnNhY2wuYwppbmRleCBjZmQ0ZGE2MTMxNjAuLjQ5ZWJhODI0OTk4ZiAxMDA2NDQKLS0t
IGEvZnMvY2lmcy9jaWZzYWNsLmMKKysrIGIvZnMvY2lmcy9jaWZzYWNsLmMKQEAgLTUyNSw4ICs1
MjUsMTEgQEAgZXhpdF9jaWZzX2lkbWFwKHZvaWQpCiB9CiAKIC8qIGNvcHkgbnRzZCwgb3duZXIg
c2lkLCBhbmQgZ3JvdXAgc2lkIGZyb20gYSBzZWN1cml0eSBkZXNjcmlwdG9yIHRvIGFub3RoZXIg
Ki8KLXN0YXRpYyB2b2lkIGNvcHlfc2VjX2Rlc2MoY29uc3Qgc3RydWN0IGNpZnNfbnRzZCAqcG50
c2QsCi0JCQkJc3RydWN0IGNpZnNfbnRzZCAqcG5udHNkLCBfX3UzMiBzaWRzb2Zmc2V0KQorc3Rh
dGljIF9fdTMyIGNvcHlfc2VjX2Rlc2MoY29uc3Qgc3RydWN0IGNpZnNfbnRzZCAqcG50c2QsCisJ
CQkJc3RydWN0IGNpZnNfbnRzZCAqcG5udHNkLAorCQkJCV9fdTMyIHNpZHNvZmZzZXQsCisJCQkJ
c3RydWN0IGNpZnNfc2lkICpwb3duZXJzaWQsCisJCQkJc3RydWN0IGNpZnNfc2lkICpwZ3Jwc2lk
KQogewogCXN0cnVjdCBjaWZzX3NpZCAqb3duZXJfc2lkX3B0ciwgKmdyb3VwX3NpZF9wdHI7CiAJ
c3RydWN0IGNpZnNfc2lkICpub3duZXJfc2lkX3B0ciwgKm5ncm91cF9zaWRfcHRyOwpAQCAtNTQw
LDE5ICs1NDMsMjUgQEAgc3RhdGljIHZvaWQgY29weV9zZWNfZGVzYyhjb25zdCBzdHJ1Y3QgY2lm
c19udHNkICpwbnRzZCwKIAlwbm50c2QtPmdzaWRvZmZzZXQgPSBjcHVfdG9fbGUzMihzaWRzb2Zm
c2V0ICsgc2l6ZW9mKHN0cnVjdCBjaWZzX3NpZCkpOwogCiAJLyogY29weSBvd25lciBzaWQgKi8K
LQlvd25lcl9zaWRfcHRyID0gKHN0cnVjdCBjaWZzX3NpZCAqKSgoY2hhciAqKXBudHNkICsKKwlp
ZiAocG93bmVyc2lkKQorCQlvd25lcl9zaWRfcHRyID0gcG93bmVyc2lkOworCWVsc2UKKwkJb3du
ZXJfc2lkX3B0ciA9IChzdHJ1Y3QgY2lmc19zaWQgKikoKGNoYXIgKilwbnRzZCArCiAJCQkJbGUz
Ml90b19jcHUocG50c2QtPm9zaWRvZmZzZXQpKTsKIAlub3duZXJfc2lkX3B0ciA9IChzdHJ1Y3Qg
Y2lmc19zaWQgKikoKGNoYXIgKilwbm50c2QgKyBzaWRzb2Zmc2V0KTsKIAljaWZzX2NvcHlfc2lk
KG5vd25lcl9zaWRfcHRyLCBvd25lcl9zaWRfcHRyKTsKIAogCS8qIGNvcHkgZ3JvdXAgc2lkICov
Ci0JZ3JvdXBfc2lkX3B0ciA9IChzdHJ1Y3QgY2lmc19zaWQgKikoKGNoYXIgKilwbnRzZCArCisJ
aWYgKHBncnBzaWQpCisJCWdyb3VwX3NpZF9wdHIgPSBwZ3Jwc2lkOworCWVsc2UKKwkJZ3JvdXBf
c2lkX3B0ciA9IChzdHJ1Y3QgY2lmc19zaWQgKikoKGNoYXIgKilwbnRzZCArCiAJCQkJbGUzMl90
b19jcHUocG50c2QtPmdzaWRvZmZzZXQpKTsKIAluZ3JvdXBfc2lkX3B0ciA9IChzdHJ1Y3QgY2lm
c19zaWQgKikoKGNoYXIgKilwbm50c2QgKyBzaWRzb2Zmc2V0ICsKIAkJCQkJc2l6ZW9mKHN0cnVj
dCBjaWZzX3NpZCkpOwogCWNpZnNfY29weV9zaWQobmdyb3VwX3NpZF9wdHIsIGdyb3VwX3NpZF9w
dHIpOwogCi0JcmV0dXJuOworCXJldHVybiBzaWRzb2Zmc2V0ICsgKDIgKiBzaXplb2Yoc3RydWN0
IGNpZnNfc2lkKSk7CiB9CiAKIApAQCAtNjY3LDE1ICs2NzYsMjEgQEAgc3RhdGljIHZvaWQgbW9k
ZV90b19hY2Nlc3NfZmxhZ3ModW1vZGVfdCBtb2RlLCB1bW9kZV90IGJpdHNfdG9fdXNlLAogCXJl
dHVybjsKIH0KIAotc3RhdGljIF9fdTE2IGNpZnNfY29weV9hY2Uoc3RydWN0IGNpZnNfYWNlICpk
c3QsIHN0cnVjdCBjaWZzX2FjZSAqc3JjKQorc3RhdGljIF9fdTE2IGNpZnNfY29weV9hY2Uoc3Ry
dWN0IGNpZnNfYWNlICpkc3QsIHN0cnVjdCBjaWZzX2FjZSAqc3JjLCBzdHJ1Y3QgY2lmc19zaWQg
KnBzaWQpCiB7CiAJX191MTYgc2l6ZSA9IDEgKyAxICsgMiArIDQ7CiAKIAlkc3QtPnR5cGUgPSBz
cmMtPnR5cGU7CiAJZHN0LT5mbGFncyA9IHNyYy0+ZmxhZ3M7Ci0JZHN0LT5zaXplID0gc3JjLT5z
aXplOwogCWRzdC0+YWNjZXNzX3JlcSA9IHNyYy0+YWNjZXNzX3JlcTsKLQlzaXplICs9IGNpZnNf
Y29weV9zaWQoJmRzdC0+c2lkLCAmc3JjLT5zaWQpOworCisJLyogQ2hlY2sgaWYgdGhlcmUncyBh
IHJlcGxhY2VtZW50IHNpZCBzcGVjaWZpZWQgKi8KKwlpZiAocHNpZCkKKwkJc2l6ZSArPSBjaWZz
X2NvcHlfc2lkKCZkc3QtPnNpZCwgcHNpZCk7CisJZWxzZQorCQlzaXplICs9IGNpZnNfY29weV9z
aWQoJmRzdC0+c2lkLCAmc3JjLT5zaWQpOworCisJZHN0LT5zaXplID0gY3B1X3RvX2xlMTYoc2l6
ZSk7CiAKIAlyZXR1cm4gc2l6ZTsKIH0KQEAgLTEwMjYsNyArMTA0MSw3IEBAIHN0YXRpYyB2b2lk
IHBvcHVsYXRlX25ld19hY2VzKGNoYXIgKm5hY2xfYmFzZSwKIAkqcG5zaXplID0gbnNpemU7CiB9
CiAKLXN0YXRpYyBfX3UxNiByZXBsYWNlX3NpZHNfYW5kX2NvcHlfYWNlcyhzdHJ1Y3QgY2lmc19h
Y2wgKnBkYWNsLCBzdHJ1Y3QgY2lmc19hY2wgKnBuZGFjbCwgCitzdGF0aWMgX191MTYgcmVwbGFj
ZV9zaWRzX2FuZF9jb3B5X2FjZXMoc3RydWN0IGNpZnNfYWNsICpwZGFjbCwgc3RydWN0IGNpZnNf
YWNsICpwbmRhY2wsCiAJCXN0cnVjdCBjaWZzX3NpZCAqcG93bmVyc2lkLCBzdHJ1Y3QgY2lmc19z
aWQgKnBncnBzaWQsCiAJCXN0cnVjdCBjaWZzX3NpZCAqcG5vd25lcnNpZCwgc3RydWN0IGNpZnNf
c2lkICpwbmdycHNpZCkKIHsKQEAgLTExMjQsNyArMTEzOSw3IEBAIHN0YXRpYyBpbnQgc2V0X2No
bW9kX2RhY2woc3RydWN0IGNpZnNfYWNsICpwZGFjbCwgc3RydWN0IGNpZnNfYWNsICpwbmRhY2ws
CiAJCQlnb3RvIG5leHRfYWNlOwogCQl9CiAKLQkJbnNpemUgKz0gY2lmc19jb3B5X2FjZShwbm50
YWNlLCBwbnRhY2UpOworCQluc2l6ZSArPSBjaWZzX2NvcHlfYWNlKHBubnRhY2UsIHBudGFjZSwg
TlVMTCk7CiAJCW51bV9hY2VzKys7CiAKIG5leHRfYWNlOgpAQCAtMTI1MCwyOCArMTI2NSwzMCBA
QCBzdGF0aWMgaW50IGJ1aWxkX3NlY19kZXNjKHN0cnVjdCBjaWZzX250c2QgKnBudHNkLCBzdHJ1
Y3QgY2lmc19udHNkICpwbm50c2QsCiAJX191MzIgbmRhY2xvZmZzZXQ7CiAJX191MzIgc2lkc29m
ZnNldDsKIAlzdHJ1Y3QgY2lmc19zaWQgKm93bmVyX3NpZF9wdHIsICpncm91cF9zaWRfcHRyOwot
CXN0cnVjdCBjaWZzX3NpZCAqbm93bmVyX3NpZF9wdHIsICpuZ3JvdXBfc2lkX3B0cjsKKwlzdHJ1
Y3QgY2lmc19zaWQgKm5vd25lcl9zaWRfcHRyID0gTlVMTCwgKm5ncm91cF9zaWRfcHRyID0gTlVM
TDsKIAlzdHJ1Y3QgY2lmc19hY2wgKmRhY2xfcHRyID0gTlVMTDsgIC8qIG5vIG5lZWQgZm9yIFNB
Q0wgcHRyICovCiAJc3RydWN0IGNpZnNfYWNsICpuZGFjbF9wdHIgPSBOVUxMOyAvKiBubyBuZWVk
IGZvciBTQUNMIHB0ciAqLwogCWNoYXIgKmVuZF9vZl9hY2wgPSAoKGNoYXIgKilwbnRzZCkgKyBz
ZWNkZXNjbGVuOworCXUxNiBzaXplID0gMDsKIAotCWlmIChwbm1vZGUgJiYgKnBubW9kZSAhPSBO
T19DSEFOR0VfNjQpIHsgLyogY2htb2QgKi8KLQkJb3duZXJfc2lkX3B0ciA9IChzdHJ1Y3QgY2lm
c19zaWQgKikoKGNoYXIgKilwbnRzZCArCi0JCQkJbGUzMl90b19jcHUocG50c2QtPm9zaWRvZmZz
ZXQpKTsKLQkJZ3JvdXBfc2lkX3B0ciA9IChzdHJ1Y3QgY2lmc19zaWQgKikoKGNoYXIgKilwbnRz
ZCArCi0JCQkJbGUzMl90b19jcHUocG50c2QtPmdzaWRvZmZzZXQpKTsKLQkJZGFjbG9mZnNldCA9
IGxlMzJfdG9fY3B1KHBudHNkLT5kYWNsb2Zmc2V0KTsKLQkJaWYgKGRhY2xvZmZzZXQpIHsKLQkJ
CWRhY2xfcHRyID0gKHN0cnVjdCBjaWZzX2FjbCAqKSgoY2hhciAqKXBudHNkICsgZGFjbG9mZnNl
dCk7Ci0JCQlpZiAoZW5kX29mX2FjbCA8IChjaGFyICopZGFjbF9wdHIgKyBsZTE2X3RvX2NwdShk
YWNsX3B0ci0+c2l6ZSkpIHsKLQkJCQljaWZzX2RiZyhWRlMsICJFeGlzdGluZyBBQ0wgc2l6ZSBp
cyB3cm9uZy4gRGlzY2FyZGluZyBvbGQgQUNMXG4iKTsKLQkJCQlkYWNsX3B0ciA9IE5VTEw7Ci0J
CQl9CisJZGFjbG9mZnNldCA9IGxlMzJfdG9fY3B1KHBudHNkLT5kYWNsb2Zmc2V0KTsKKwlpZiAo
ZGFjbG9mZnNldCkgeworCQlkYWNsX3B0ciA9IChzdHJ1Y3QgY2lmc19hY2wgKikoKGNoYXIgKilw
bnRzZCArIGRhY2xvZmZzZXQpOworCQlpZiAoZW5kX29mX2FjbCA8IChjaGFyICopZGFjbF9wdHIg
KyBsZTE2X3RvX2NwdShkYWNsX3B0ci0+c2l6ZSkpIHsKKwkJCWNpZnNfZGJnKFZGUywgIkV4aXN0
aW5nIEFDTCBzaXplIGlzIHdyb25nLiBEaXNjYXJkaW5nIG9sZCBBQ0xcbiIpOworCQkJZGFjbF9w
dHIgPSBOVUxMOwogCQl9CisJfQorCisJb3duZXJfc2lkX3B0ciA9IChzdHJ1Y3QgY2lmc19zaWQg
KikoKGNoYXIgKilwbnRzZCArCisJCQlsZTMyX3RvX2NwdShwbnRzZC0+b3NpZG9mZnNldCkpOwor
CWdyb3VwX3NpZF9wdHIgPSAoc3RydWN0IGNpZnNfc2lkICopKChjaGFyICopcG50c2QgKworCQkJ
bGUzMl90b19jcHUocG50c2QtPmdzaWRvZmZzZXQpKTsKIAorCWlmIChwbm1vZGUgJiYgKnBubW9k
ZSAhPSBOT19DSEFOR0VfNjQpIHsgLyogY2htb2QgKi8KIAkJbmRhY2xvZmZzZXQgPSBzaXplb2Yo
c3RydWN0IGNpZnNfbnRzZCk7CiAJCW5kYWNsX3B0ciA9IChzdHJ1Y3QgY2lmc19hY2wgKikoKGNo
YXIgKilwbm50c2QgKyBuZGFjbG9mZnNldCk7Ci0JCW5kYWNsX3B0ci0+cmV2aXNpb24gPSAKKwkJ
bmRhY2xfcHRyLT5yZXZpc2lvbiA9CiAJCQlkYWNsb2Zmc2V0ID8gZGFjbF9wdHItPnJldmlzaW9u
IDogY3B1X3RvX2xlMTYoQUNMX1JFVklTSU9OKTsKIAogCQluZGFjbF9wdHItPnNpemUgPSBjcHVf
dG9fbGUzMigwKTsKQEAgLTEyNzksMTEgKzEyOTYsMTMgQEAgc3RhdGljIGludCBidWlsZF9zZWNf
ZGVzYyhzdHJ1Y3QgY2lmc19udHNkICpwbnRzZCwgc3RydWN0IGNpZnNfbnRzZCAqcG5udHNkLAog
CiAJCXJjID0gc2V0X2NobW9kX2RhY2woZGFjbF9wdHIsIG5kYWNsX3B0ciwgb3duZXJfc2lkX3B0
ciwgZ3JvdXBfc2lkX3B0ciwKIAkJCQkgICAgcG5tb2RlLCBtb2RlX2Zyb21fc2lkKTsKKwogCQlz
aWRzb2Zmc2V0ID0gbmRhY2xvZmZzZXQgKyBsZTE2X3RvX2NwdShuZGFjbF9wdHItPnNpemUpOwot
CQkvKiBjb3B5IHNlYyBkZXNjIGNvbnRyb2wgcG9ydGlvbiAmIG93bmVyIGFuZCBncm91cCBzaWRz
ICovCi0JCWNvcHlfc2VjX2Rlc2MocG50c2QsIHBubnRzZCwgc2lkc29mZnNldCk7Ci0JCSpwbnNl
Y2Rlc2NsZW4gPSBzaWRzb2Zmc2V0ICsgKDIgKiBzaXplb2Yoc3RydWN0IGNpZnNfc2lkKSk7Ci0J
CSphY2xmbGFnID0gQ0lGU19BQ0xfREFDTDsKKwkJLyogY29weSB0aGUgbm9uLWRhY2wgcG9ydGlv
biBvZiBzZWNkZXNjICovCisJCSpwbnNlY2Rlc2NsZW4gPSBjb3B5X3NlY19kZXNjKHBudHNkLCBw
bm50c2QsIHNpZHNvZmZzZXQsCisJCQkJTlVMTCwgTlVMTCk7CisKKwkJKmFjbGZsYWcgfD0gQ0lG
U19BQ0xfREFDTDsKIAl9IGVsc2UgewogCQluZGFjbG9mZnNldCA9IHNpemVvZihzdHJ1Y3QgY2lm
c19udHNkKTsKIAkJbmRhY2xfcHRyID0gKHN0cnVjdCBjaWZzX2FjbCAqKSgoY2hhciAqKXBubnRz
ZCArIG5kYWNsb2Zmc2V0KTsKQEAgLTEyOTMsMTIgKzEzMTIsMTIgQEAgc3RhdGljIGludCBidWls
ZF9zZWNfZGVzYyhzdHJ1Y3QgY2lmc19udHNkICpwbnRzZCwgc3RydWN0IGNpZnNfbnRzZCAqcG5u
dHNkLAogCiAJCWlmICh1aWRfdmFsaWQodWlkKSkgeyAvKiBjaG93biAqLwogCQkJdWlkX3QgaWQ7
Ci0JCQlvd25lcl9zaWRfcHRyID0gKHN0cnVjdCBjaWZzX3NpZCAqKSgoY2hhciAqKXBubnRzZCAr
Ci0JCQkJCWxlMzJfdG9fY3B1KHBubnRzZC0+b3NpZG9mZnNldCkpOwogCQkJbm93bmVyX3NpZF9w
dHIgPSBrbWFsbG9jKHNpemVvZihzdHJ1Y3QgY2lmc19zaWQpLAogCQkJCQkJCQlHRlBfS0VSTkVM
KTsKLQkJCWlmICghbm93bmVyX3NpZF9wdHIpCi0JCQkJcmV0dXJuIC1FTk9NRU07CisJCQlpZiAo
IW5vd25lcl9zaWRfcHRyKSB7CisJCQkJcmMgPSAtRU5PTUVNOworCQkJCWdvdG8gY2hvd25fY2hn
cnBfZXhpdDsKKwkJCX0KIAkJCWlkID0gZnJvbV9rdWlkKCZpbml0X3VzZXJfbnMsIHVpZCk7CiAJ
CQlpZiAoaWRfZnJvbV9zaWQpIHsKIAkJCQlzdHJ1Y3Qgb3duZXJfc2lkICpvc2lkID0gKHN0cnVj
dCBvd25lcl9zaWQgKilub3duZXJfc2lkX3B0cjsKQEAgLTEzMDksMjcgKzEzMjgsMjUgQEAgc3Rh
dGljIGludCBidWlsZF9zZWNfZGVzYyhzdHJ1Y3QgY2lmc19udHNkICpwbnRzZCwgc3RydWN0IGNp
ZnNfbnRzZCAqcG5udHNkLAogCQkJCW9zaWQtPlN1YkF1dGhvcml0aWVzWzBdID0gY3B1X3RvX2xl
MzIoODgpOwogCQkJCW9zaWQtPlN1YkF1dGhvcml0aWVzWzFdID0gY3B1X3RvX2xlMzIoMSk7CiAJ
CQkJb3NpZC0+U3ViQXV0aG9yaXRpZXNbMl0gPSBjcHVfdG9fbGUzMihpZCk7CisKIAkJCX0gZWxz
ZSB7IC8qIGxvb2t1cCBzaWQgd2l0aCB1cGNhbGwgKi8KIAkJCQlyYyA9IGlkX3RvX3NpZChpZCwg
U0lET1dORVIsIG5vd25lcl9zaWRfcHRyKTsKIAkJCQlpZiAocmMpIHsKIAkJCQkJY2lmc19kYmco
RllJLCAiJXM6IE1hcHBpbmcgZXJyb3IgJWQgZm9yIG93bmVyIGlkICVkXG4iLAogCQkJCQkJIF9f
ZnVuY19fLCByYywgaWQpOwotCQkJCQlrZnJlZShub3duZXJfc2lkX3B0cik7Ci0JCQkJCXJldHVy
biByYzsKKwkJCQkJZ290byBjaG93bl9jaGdycF9leGl0OwogCQkJCX0KIAkJCX0KLQkJCWNpZnNf
Y29weV9zaWQob3duZXJfc2lkX3B0ciwgbm93bmVyX3NpZF9wdHIpOwotCQkJa2ZyZWUobm93bmVy
X3NpZF9wdHIpOwotCQkJKmFjbGZsYWcgPSBDSUZTX0FDTF9PV05FUjsKKwkJCSphY2xmbGFnIHw9
IENJRlNfQUNMX09XTkVSOwogCQl9CiAJCWlmIChnaWRfdmFsaWQoZ2lkKSkgeyAvKiBjaGdycCAq
LwogCQkJZ2lkX3QgaWQ7Ci0JCQlncm91cF9zaWRfcHRyID0gKHN0cnVjdCBjaWZzX3NpZCAqKSgo
Y2hhciAqKXBubnRzZCArCi0JCQkJCWxlMzJfdG9fY3B1KHBubnRzZC0+Z3NpZG9mZnNldCkpOwog
CQkJbmdyb3VwX3NpZF9wdHIgPSBrbWFsbG9jKHNpemVvZihzdHJ1Y3QgY2lmc19zaWQpLAogCQkJ
CQkJCQlHRlBfS0VSTkVMKTsKLQkJCWlmICghbmdyb3VwX3NpZF9wdHIpCi0JCQkJcmV0dXJuIC1F
Tk9NRU07CisJCQlpZiAoIW5ncm91cF9zaWRfcHRyKSB7CisJCQkJcmMgPSAtRU5PTUVNOworCQkJ
CWdvdG8gY2hvd25fY2hncnBfZXhpdDsKKwkJCX0KIAkJCWlkID0gZnJvbV9rZ2lkKCZpbml0X3Vz
ZXJfbnMsIGdpZCk7CiAJCQlpZiAoaWRfZnJvbV9zaWQpIHsKIAkJCQlzdHJ1Y3Qgb3duZXJfc2lk
ICpnc2lkID0gKHN0cnVjdCBvd25lcl9zaWQgKiluZ3JvdXBfc2lkX3B0cjsKQEAgLTEzNDAsMTkg
KzEzNTcsMzUgQEAgc3RhdGljIGludCBidWlsZF9zZWNfZGVzYyhzdHJ1Y3QgY2lmc19udHNkICpw
bnRzZCwgc3RydWN0IGNpZnNfbnRzZCAqcG5udHNkLAogCQkJCWdzaWQtPlN1YkF1dGhvcml0aWVz
WzBdID0gY3B1X3RvX2xlMzIoODgpOwogCQkJCWdzaWQtPlN1YkF1dGhvcml0aWVzWzFdID0gY3B1
X3RvX2xlMzIoMik7CiAJCQkJZ3NpZC0+U3ViQXV0aG9yaXRpZXNbMl0gPSBjcHVfdG9fbGUzMihp
ZCk7CisKIAkJCX0gZWxzZSB7IC8qIGxvb2t1cCBzaWQgd2l0aCB1cGNhbGwgKi8KIAkJCQlyYyA9
IGlkX3RvX3NpZChpZCwgU0lER1JPVVAsIG5ncm91cF9zaWRfcHRyKTsKIAkJCQlpZiAocmMpIHsK
IAkJCQkJY2lmc19kYmcoRllJLCAiJXM6IE1hcHBpbmcgZXJyb3IgJWQgZm9yIGdyb3VwIGlkICVk
XG4iLAogCQkJCQkJIF9fZnVuY19fLCByYywgaWQpOwotCQkJCQlrZnJlZShuZ3JvdXBfc2lkX3B0
cik7Ci0JCQkJCXJldHVybiByYzsKKwkJCQkJZ290byBjaG93bl9jaGdycF9leGl0OwogCQkJCX0K
IAkJCX0KLQkJCWNpZnNfY29weV9zaWQoZ3JvdXBfc2lkX3B0ciwgbmdyb3VwX3NpZF9wdHIpOwot
CQkJa2ZyZWUobmdyb3VwX3NpZF9wdHIpOwotCQkJKmFjbGZsYWcgPSBDSUZTX0FDTF9HUk9VUDsK
KwkJCSphY2xmbGFnIHw9IENJRlNfQUNMX0dST1VQOwogCQl9CisKKwkJaWYgKGRhY2xvZmZzZXQp
IHsKKwkJCS8qIFJlcGxhY2UgQUNFcyBmb3Igb2xkIG93bmVyIHdpdGggbmV3IG9uZSAqLworCQkJ
c2l6ZSA9IHJlcGxhY2Vfc2lkc19hbmRfY29weV9hY2VzKGRhY2xfcHRyLCBuZGFjbF9wdHIsCisJ
CQkJCW93bmVyX3NpZF9wdHIsIGdyb3VwX3NpZF9wdHIsCisJCQkJCW5vd25lcl9zaWRfcHRyLCBu
Z3JvdXBfc2lkX3B0cik7CisJCQluZGFjbF9wdHItPnNpemUgPSBjcHVfdG9fbGUxNihzaXplKTsK
KwkJfQorCisJCXNpZHNvZmZzZXQgPSBuZGFjbG9mZnNldCArIGxlMTZfdG9fY3B1KG5kYWNsX3B0
ci0+c2l6ZSk7CisJCS8qIGNvcHkgdGhlIG5vbi1kYWNsIHBvcnRpb24gb2Ygc2VjZGVzYyAqLwor
CQkqcG5zZWNkZXNjbGVuID0gY29weV9zZWNfZGVzYyhwbnRzZCwgcG5udHNkLCBzaWRzb2Zmc2V0
LAorCQkJCW5vd25lcl9zaWRfcHRyLCBuZ3JvdXBfc2lkX3B0cik7CisKK2Nob3duX2NoZ3JwX2V4
aXQ6CisJCS8qIGVycm9ycyBjb3VsZCBqdW1wIGhlcmUuIFNvIG1ha2Ugc3VyZSB3ZSByZXR1cm4g
c29vbiBhZnRlciB0aGlzICovCisJCWtmcmVlKG5vd25lcl9zaWRfcHRyKTsKKwkJa2ZyZWUobmdy
b3VwX3NpZF9wdHIpOwogCX0KIAogCXJldHVybiByYzsKQEAgLTE1OTgsNiArMTYzMSwxOCBAQCBp
ZF9tb2RlX3RvX2NpZnNfYWNsKHN0cnVjdCBpbm9kZSAqaW5vZGUsIGNvbnN0IGNoYXIgKnBhdGgs
IF9fdTY0ICpwbm1vZGUsCiAJCQluc2VjZGVzY2xlbiArPSBzaXplb2Yoc3RydWN0IGNpZnNfYWNl
KTsKIAkJZWxzZSAvKiBjaWZzYWNsICovCiAJCQluc2VjZGVzY2xlbiArPSA1ICogc2l6ZW9mKHN0
cnVjdCBjaWZzX2FjZSk7CisJfSBlbHNlIHsgLyogY2hvd24gKi8KKwkJLyogV2hlbiBvd25lcnNo
aXAgY2hhbmdlcywgY2hhbmdlcyBuZXcgb3duZXIgc2lkIGxlbmd0aCBjb3VsZCBiZSBkaWZmZXJl
bnQgKi8KKwkJbnNlY2Rlc2NsZW4gPSBzaXplb2Yoc3RydWN0IGNpZnNfbnRzZCkgKyAoc2l6ZW9m
KHN0cnVjdCBjaWZzX3NpZCkgKiAyKTsKKwkJZGFjbG9mZnNldCA9IGxlMzJfdG9fY3B1KHBudHNk
LT5kYWNsb2Zmc2V0KTsKKwkJaWYgKGRhY2xvZmZzZXQpIHsKKwkJCWRhY2xfcHRyID0gKHN0cnVj
dCBjaWZzX2FjbCAqKSgoY2hhciAqKXBudHNkICsgZGFjbG9mZnNldCk7CisJCQlpZiAobW9kZV9m
cm9tX3NpZCkKKwkJCQluc2VjZGVzY2xlbiArPQorCQkJCQlsZTE2X3RvX2NwdShkYWNsX3B0ci0+
bnVtX2FjZXMpICogc2l6ZW9mKHN0cnVjdCBjaWZzX2FjZSk7CisJCQllbHNlIC8qIGNpZnNhY2wg
Ki8KKwkJCQluc2VjZGVzY2xlbiArPSBsZTE2X3RvX2NwdShkYWNsX3B0ci0+c2l6ZSk7CisJCX0K
IAl9CiAKIAkvKgotLSAKMi4yNS4xCgo=
--00000000000011424c05bbb05e87--
